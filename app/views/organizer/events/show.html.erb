<div class="row-fluid">
  <div class="span12">
    <ul class="inline">
      <div class="btn-group">
        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
          <%= @event.title %>
          <span class="caret"></span>
        </a>
        <ul class="dropdown-menu">
          <% @events.each do |e| %>
          <li><%= link_to "#{e.title} | #{e.date.strftime('%d %b')}", organizer_event_path(e) %></li>
          <% end %>
        </ul>
      </div>
      <div class="pull-right"><%= render 'search' %></div>
    </ul>
  </div>
</div>
<div class="row-fluid">
  <aside class="span3">
    <hr>
    <%= link_to image_tag('blue.png'), '/auth/stripe_connect', class: "" unless current_user.api_key %>
    <div class="accordion" id="accordion2">
      <div class="accordion-group">
        <div class="accordion-heading">
          <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseFour">
            Event Stats <i class="icon-plus"></i>
          </a>
        </div>
        <div id="collapseFour" class="accordion-body collapse">
          <div class="accordion-inner">
            <dl class="well">
              <dt>time left</dt>
              <dd><%= @event.date > DateTime.now ? distance_of_time_in_words(Time.now, @event.date, include_seconds = false) : "Time's up!"  %></dd>
              <dt>funding:</dt>
              <dd><%= number_to_currency(@event.orders.funding.sum(:quantity) * @event.ticket_price) %></dd>
              <dt>capacity:</dt>
              <dd><%= @event.capacity %></dd>
              <dt>tickets-left: </dt>
              <dd><%= @event.capacity - @event.orders.funding.sum(:quantity) %></dd>
            </dl>
          </div>
        </div>
      </div>
    <% unless @event.state_cancelled? || current_user.api_key.nil? %>
      <div class="accordion-group">
        <div class="accordion-heading">
          <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
            Charge Options <i class="icon-plus"></i>
          </a>
        </div>
        <div id="collapseOne" class="accordion-body collapse">
          <div class="accordion-inner">
            <%= form_tag  charge_or_refund_orders_path, method: :post  do %>
            <ul class="nav nav-tabs nav-stacked">
              <li><%= link_to "Charge All", charge_all_orders_path(event_id: @event.id), method: :post, class: "" %></li>
              <li><%= submit_tag "Charge Selected", name: 'charge', class: "link-button" if current_user.api_key %></li>
              <li><%= submit_tag "Refund Selected", name: 'refund', class: "link-button" if current_user.api_key %></li>
              <li><%= submit_tag "Cancel Selected", name: 'cancel', class: "link-button" if current_user.api_key %></li>
              <li><%= link_to "Cancel Event", cancel_organizer_event_path(@event), data: { confirm: "Are you sure you want to cancel the current event?" }, class: "" %></li>
            </ul>
          </div>
        </div>
      </div>
    <% end %>
      <div class="accordion-group">
        <div class="accordion-heading">
          <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseTwo">
            Event Options <i class="icon-plus"></i>
          </a>
        </div>
        <div id="collapseTwo" class="accordion-body collapse">
          <div class="accordion-inner">
            <ul class="nav nav-tabs nav-stacked">
              <li><%= link_to "View Event", event_path(@event), class: "" unless @event.state_cancelled? %></li>
              <li><%= link_to "New Event", new_organizer_event_path(@event), class: "" %></li>
              <li><%= link_to "Edit Event", edit_organizer_event_path(@event), class: "" unless @event.state_cancelled? %></li>
              <li><%= link_to "Orders PDF", organizer_event_path(@event, format: "pdf"), class: "" %></li>
              <li><%= link_to "Tickets PDF", organizer_event_tickets_path(@event, format: "pdf"), class: "" %></li>
              <li><%= link_to "Check-in View", organizer_event_tickets_path(@event), class: "" unless @event.state_cancelled? %></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="accordion-group" is="event-accordian">
        <div class="accordion-heading">
          <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseThree">
            Filter Orders <i class="icon-plus"></i>
          </a>
        </div>
        <div id="collapseThree" class="accordion-body collapse">
          <div class="accordion-inner">
            <ul class="nav nav-tabs nav-stacked">
              <li><a href="<%= organizer_event_path(@event) %>">All<span class="badge badge-info pull-right"><%= @event.orders.sum(:quantity) %></span></a></li>
              <li><a href="<%= request.path + '?pending=true' %>">Ordered<span class="badge badge-warning pull-right"><%= @event.orders.pending.sum(:quantity) %></span></a></li>
              <li><a href="<%= request.path + '?tickets_sent=true' %>">Paid<span class="badge badge-success pull-right"><%= @event.orders.tickets_sent.sum(:quantity) %></span></a></li>
              <li><a href="<%= request.path + '?failed=true' %>">Failed<span class="badge badge-important pull-right"><%= @event.orders.failed.sum(:quantity) %></span></a></li>
              <li><a href="<%= request.path + '?refunded=true' %>">Refunded<span class="badge badge-inverse pull-right"><%= @event.orders.refunded.sum(:quantity) %></span></a></li>
              <li><a href="<%= request.path + '?refunded=true' %>">Cancelled<span class="badge pull-right"><%= @event.orders.cancelled.sum(:quantity) %></span></a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="span9">
      <table class="table table-striped table-bordered" id="organizer-customers">
        <thead>
          <tr>
            <th>
              <button type="button" id="check_all", class="btn btn-mini">
                <i class="icon-ok"></i>
              </button>
            </th>
            <th>Name</th>
            <th>Email</th>
            <th>Admits:</th>
            <th>Order Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% @orders.each do |order| %>
          <tr>
            <td><%= check_box_tag "order_ids[]", order.id %> </td>
            <td><%= order.name %> </td>
            <td><%= order.email %> </td>
            <td> <%= order.quantity %></td>
            <td> <%= number_to_currency(order.total) %></td>
            <td> <span class="label"><%= order.stripe_event  %></span> </td>
            <% end %>
          </tr>
        </tbody>
      </table>
    <% end %>
    <%= will_paginate @orders %>
  </div> <!-- /table form -->
</div> <!-- /row -->
